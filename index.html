<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金門醫院放射科預假單系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式 */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0.5rem; /* 行動裝置的邊距縮小 */
            background-color: #f3f4f6; /* Tailwind gray-100 */
            color: #1f2937; /* Tailwind gray-800 */
            min-height: 100vh;
            box-sizing: border-box;
            font-size: 14px; /* 行動裝置的基本字體大小 */
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            body {
                padding: 1.5rem;
                font-size: 16px;
            }
        }
        .main-container {
            max-width: 1280px; /* Tailwind lg:max-w-7xl */
            margin-left: auto;
            margin-right: auto;
        }
        /* 表頭儲存格的通用固定樣式 */
        .sticky-table-header th {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            background-color: #f9fafb; /* gray-50, 與原表頭背景色一致 */
            z-index: 3; /* 確保在表格內容之上，但在最頂部按鈕區之下 */
        }
        .date-header {
            width: 70px; min-width: 70px; /* 行動裝置的寬度縮小 */
            overflow: hidden; white-space: nowrap;
            text-align: center; padding: 0.25rem 0; /* Tailwind py-1 */
            border-bottom: 1px solid #6b7280; /* Tailwind gray-500 */
            border-right: 1px solid #6b7280; 
            font-size: 0.7rem; vertical-align: top;
            /* background-color is handled by .sticky-table-header th */
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .date-header {
                width: 90px; min-width: 90px;
                padding: 0.375rem 0; /* Tailwind py-1.5 */
                font-size: 0.8rem;
                border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563; /* Tailwind gray-600 */
            }
        }
        .name-header {
            width: 80px; min-width: 80px; /* 行動裝置的寬度縮小 */
            text-align: left; padding: 0.375rem; /* Tailwind p-1.5 */
            border-bottom: 1px solid #6b7280; 
            border-right: 1px solid #6b7280;  
            /* position sticky and z-index are handled by .sticky-table-header th */
            left: 0; /* 保持水平固定 */
            /* background-color is handled by .sticky-table-header th */
            font-size: 0.8rem;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .name-header {
                width: 100px; min-width: 100px;
                padding: 0.5rem; /* Tailwind p-2 */
                font-size: 1rem;
                 border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563;
            }
        }
        .order-header {
            width: 40px; min-width: 40px; /* 行動裝置的寬度縮小 */
            text-align: center; padding: 0.375rem; 
            border-bottom: 1px solid #6b7280; 
            border-right: 1px solid #6b7280;  
            /* position sticky and z-index are handled by .sticky-table-header th */
            left: 80px; /* 配合 name-header 的寬度調整, 保持水平固定 */
            /* background-color is handled by .sticky-table-header th */
            font-size: 0.8rem;
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .order-header {
                width: 50px; min-width: 50px;
                padding: 0.5rem;
                left: 100px;
                font-size: 1rem;
                border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563;
            }
        }
        .date-header:last-child {
            border-right: none;
        }

        .data-cell {
            width: 70px; height: 32px; /* 行動裝置的尺寸縮小 */
            text-align: center;
            border-bottom: 1px solid #6b7280; 
            border-right: 1px solid #6b7280;  
            padding: 0; cursor: pointer;
            position: relative;
            background-color: white; 
            font-size: 0.8rem;
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .data-cell {
                 width: 90px; height: 36px;
                 font-size: 0.9rem;
                 border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563;
            }
        }
        tr td.data-cell:last-of-type {
            border-right: none;
        }

        .name-cell { /* 內容區的姓名欄 */
            text-align: left; padding-left: 0.375rem; font-weight: 500; 
            border-bottom: 1px solid #6b7280; 
            border-right: 1px solid #6b7280;  
            height: 32px; line-height: 32px; /* 縮小高度 */
            position: -webkit-sticky; 
            position: sticky;
            left: 0;
            background-color: white; 
            z-index: 1; 
            font-size: 0.8rem;
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .name-cell {
                padding-left: 0.5rem;
                height: 36px; line-height: 36px;
                font-size: 1rem;
                border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563;
            }
        }
        .order-cell { /* 內容區的順位欄 */
            text-align: center; 
            border-bottom: 1px solid #6b7280; 
            border-right: 1px solid #6b7280;  
            height: 32px; line-height: 32px; /* 縮小高度 */
            position: -webkit-sticky; 
            position: sticky;
            left: 80px; /* 調整 */
            background-color: white; 
            z-index: 1; 
            font-size: 0.8rem;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .order-cell {
                height: 36px; line-height: 36px;
                left: 100px;
                font-size: 1rem;
                border-bottom-width: 2px;
                border-right-width: 2px;
                border-color: #4b5563;
            }
        }
        .order-cell input[type="number"] {
            width: 90%; /* 配合較小的儲存格調整 */
            font-size: 0.8rem;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .order-cell input[type="number"] {
                width: 80%;
                font-size: 1rem;
            }
        }
        .order-input-modified { /* 用於標示使用者剛修改過的輸入框 */
            background-color: #fed7aa !important; /* Tailwind orange-200 */
        }

        .weekend { 
            background-color: #e0e7ff !important; 
        }
        .holiday { 
            background-color: #fffbeb !important; 
        }
        .holiday-name {
            display: block; font-size: 0.6rem; /* 略微縮小 */
            color: #d97706; 
            margin-top: 1px; white-space: normal; line-height: 1.2;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .holiday-name {
                font-size: 0.65rem;
                margin-top: 2px;
            }
        }
        .leave-form-container {
            margin-bottom: 1.5rem; /* 縮小 */
            padding: 0.75rem; /* 縮小 */
            border: 1px solid #e5e7eb; border-radius: 8px; 
            background-color: white; overflow-x: auto; 
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .leave-form-container {
                margin-bottom: 30px;
                padding: 15px;
            }
        }
        .form-title {
            font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151; 
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .form-title {
                font-size: 1.1rem; margin-bottom: 10px;
            }
        }
        .sticky-button-container {
            position: -webkit-sticky; 
            position: sticky;
            top: 0; 
            left: 0; 
            background-color: white; 
            z-index: 4; /* 比表頭高 */
            padding-top: 0.25rem; 
            padding-bottom: 0.5rem; /* 縮小 */
            border-bottom: 1px solid #e5e7eb; 
            width: -webkit-fill-available; 
            width: -moz-available;
            width: stretch;
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
             .sticky-button-container {
                 padding-bottom: 0.75rem;
             }
        }
        .sticky-button-container button {
            padding: 0.25rem 0.5rem; /* 按鈕的內距縮小 */
            font-size: 0.75rem; /* 按鈕的字體縮小 */
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .sticky-button-container button {
                padding: 0.375rem 0.75rem; /* Tailwind px-3 py-1.5 */
                font-size: 0.75rem; /* Tailwind text-xs */
            }
        }


        .leave-mark-display {
            color: #1f2937; 
            font-weight: bold; 
            border-radius: 4px; width: 80%; height: 80%;
            margin: auto; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; /* 調整 */
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .leave-mark-display {
                font-size: 0.9rem;
            }
        }
        .leave-mark-G { background-color: #f472b6; } 
        .leave-mark-A { background-color: #60a5fa; } 
        .leave-mark-C { background-color: #34d399; } 
        /* 新增 C 和 D3 的樣式 */
        .leave-mark-CC { background-color: #c084fc; } /* Example: Tailwind purple-400 */
        .leave-mark-D3 { background-color: #5eead4; } /* Example: Tailwind teal-300 */

        .leave-type-popover {
            position: absolute; background-color: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            padding: 8px; z-index: 1000; display: flex; flex-direction: column; gap: 4px; min-width: 100px;
        }
        .leave-type-popover button {
            padding: 6px 10px; border: 1px solid transparent; border-radius: 4px; text-align: left;
            cursor: pointer; font-size: 0.875rem; background-color: #f9fafb; 
            transition: background-color 0.2s, border-color 0.2s; 
            color: #1f2937; 
            font-weight: bold; 
        }
        .leave-type-popover button:hover { background-color: #f3f4f6; border-color: #e5e7eb; }
        .leave-type-popover button.popover-clear-btn { background-color: #e5e7eb; }
        .leave-type-popover button.popover-clear-btn:hover { background-color: #d1d5db; }

        .modify-order-control-button-inactive {
            background-color: #3b82f6; 
            color: white; /* 確保對比度 */
            font-weight: bold; 
        }
        .modify-order-control-button-inactive:hover {
            background-color: #2563eb; 
        }
        .modify-order-control-button-active {
            background-color: #ef4444; 
            color: white; /* 確保對比度 */
            font-weight: bold; 
        }
        .modify-order-control-button-active:hover {
            background-color: #dc2626; 
        }
        .sticky-button-container .bg-green-500,
        .sticky-button-container .bg-purple-500,
        .sticky-button-container .bg-yellow-500 {
            color: white; /* 確保彩色按鈕的對比度 */
        }


        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; padding: 0.5rem; /* 行動裝置的內距 */
        }
        .modal-content {
            background-color: white; padding: 1.5rem; /* 內距縮小 */
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            width: 90%; max-width: 360px; /* 最大寬度略微縮小 */
            text-align: center;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .modal-content {
                padding: 2rem;
                max-width: 400px;
            }
        }
        .modal-title {
            font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; color: #1f2937; 
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .modal-title {
                font-size: 1.25rem; margin-bottom: 1rem;
            }
        }
        .modal-input {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; 
            border-radius: 0.375rem; margin-bottom: 1rem; box-sizing: border-box;
        }
        .modal-message-text {
            font-size: 0.9rem; color: #374151; margin-bottom: 1rem; 
            line-height: 1.5;
        }
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .modal-message-text {
                font-size: 1rem; margin-bottom: 1.5rem;
                line-height: 1.6;
            }
        }
        .modal-buttons {
            display: flex; justify-content: flex-end; gap: 0.5rem; 
        }
        .modal-buttons-center {
            justify-content: center;
        }
        .modal-button {
            padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 500; 
            cursor: pointer; transition: background-color 0.2s; font-size: 0.8rem;
        }
         @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .modal-button {
                padding: 0.5rem 1rem; font-size: 0.875rem;
            }
        }
        .modal-button-confirm {
            background-color: #3b82f6; color: white;
        }
        .modal-button-confirm:hover {
            background-color: #2563eb; 
        }
        .modal-button-cancel {
            background-color: #e5e7eb; color: #374151; 
        }
        .modal-button-cancel:hover {
            background-color: #d1d5db; 
        }
        .modal-error {
            color: #ef4444; font-size: 0.875rem; 
            margin-top: -0.5rem; margin-bottom: 1rem; 
        }
        .hidden {
            display: none !important;
        }

        /* 列印專用樣式 */
        @media print {
            @page {
                size: landscape; 
                margin: 0.5in; 
            }

            body {
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
                font-size: 10pt !important; /* 調整列印的基本字體 */
            }

            body > * {
                display: none !important; 
            }

            .main-container,
            #leave-forms-container, 
            .print-target { 
                display: block !important;
            }
            
            .main-container {
                padding: 0 !important; 
                margin: 0 !important;
                max-width: 100% !important; 
            }
            
            .main-container > *:not(#leave-forms-container) {
                display: none !important;
            }
            
            #leave-forms-container > .leave-form-container:not(.print-target) {
                display: none !important;
            }

            .no-print,
            #passwordModal,
            #messageModal,
            .leave-type-popover,
            .order-input-modified { 
                background-color: white !important; 
                border-color: #d1d5db !important;
            }
            .order-cell input[type="number"] {
                border: none !important; 
                color: black !important; /* 確保列印的數字可見 */
                background-color: transparent !important;
            }


            .print-target {
                border: none !important;
                box-shadow: none !important;
                margin: 0 auto !important; 
                padding: 0 !important; 
                overflow: visible !important;
                width: auto !important; 
                page-break-before: always; 
                page-break-after: always; 
            }

            .print-target .sticky-button-container,
            .print-target .name-header,
            .print-target .order-header,
            .print-target .name-cell,
            .print-target .order-cell {
                position: static !important; 
                background-color: white !important; 
            }
            .print-target .date-header {
                background-color: #f9fafb !important; 
            }
            
            .print-target .form-title {
                 text-align: center; 
                 margin-bottom: 1rem;
                 font-size: 1.2rem; 
            }

            .print-target table {
                width: 100% !important;
                border-collapse: collapse !important; 
            }
             .print-target th, .print-target td {
                page-break-inside: avoid !important; 
                border: 1px solid #4b5563 !important; /* 列印時邊框變細 */
                padding: 2px 4px !important; /* 列印時內距縮小 */
                font-size: 9pt !important;
            }
            .print-target .holiday-name {
                font-size: 7pt !important;
            }

            body, .leave-mark-display, .weekend, .holiday, 
            .leave-mark-CC, .leave-mark-D3 { /* 確保新類型顏色也能列印 */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-6 text-sm sm:text-base">
    <div class="main-container mx-auto max-w-full">
        <h1 class="text-xl sm:text-2xl font-semibold text-center text-gray-800 mb-3 sm:mb-6">金門醫院放射科預假單系統</h1>
        <p id="main-instruction" class="text-gray-600 text-xs sm:text-sm mb-2 sm:mb-4 text-center leading-relaxed">
            </p>
        <p class="text-gray-500 text-xs mb-2 sm:mb-4 text-center">（註：假日列表為2025年台灣國定假日參考，實際標示依各表單日期範圍為準。）</p>

        <div id="leave-forms-container">
            </div>
    </div>

    <div id="passwordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="passwordModalTitle" class="modal-title">請輸入密碼</h3>
            <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">啟用順位修改模式需要管理員密碼。</p>
            <input type="password" id="passwordInput" class="modal-input" placeholder="輸入密碼">
            <p id="passwordError" class="modal-error hidden">密碼錯誤，請重試。</p>
            <div class="modal-buttons">
                <button id="cancelPasswordButton" class="modal-button modal-button-cancel">取消</button>
                <button id="confirmPasswordButton" class="modal-button modal-button-confirm">確認</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="messageModalTitle" class="modal-title">系統訊息</h3>
            <p id="messageModalText" class="modal-message-text">這裡顯示訊息內容。</p>
            <div class="modal-buttons modal-buttons-center">
                <button id="okMessageButton" class="modal-button modal-button-confirm">確認</button>
            </div>
        </div>
    </div>


    <script>
        // DOM 元素獲取
        const leaveFormsContainer = document.getElementById('leave-forms-container');
        const mainInstruction = document.getElementById('main-instruction');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordButton = document.getElementById('confirmPasswordButton');
        const cancelPasswordButton = document.getElementById('cancelPasswordButton');
        const passwordError = document.getElementById('passwordError');
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalText = document.getElementById('messageModalText');
        const okMessageButton = document.getElementById('okMessageButton');

        // --- 全域設定 ---
        const today = new Date();
        today.setFullYear(2025, 4, 20); 
        today.setHours(0, 0, 0, 0); 
        const appCurrentYear = today.getFullYear(); 
        const initialGlobalStartDate = new Date(appCurrentYear, 5, 9); 
        const numberOfDaysPerForm = 28; 
        const numberOfFormsToAttempt = 5; 
        const ORDER_MODIFICATION_PASSWORD = "1234"; 
        let isOrderModificationModeActive = false; 

        let employees = [
            { name: "陳振堅", order: 1 }, { name: "莊憶如", order: 2 }, { name: "朱雁翎", order: 3 },
            { name: "曾紹華", order: 4 }, { name: "李國偉", order: 5 }, { name: "洪藝瑄", order: 6 },
            { name: "高元宏", order: 7 }, { name: "傅奎愿", order: 8 }, { name: "陳盈熹", order: 9 },
            { name: "蔡芳綺", order: 10 }, { name: "李宛融", order: 11 }, { name: "徐啟仁", order: 12 },
            { name: "鄭璟樺", order: 13 },
        ];
        
        let activeModeBaseOrders = []; 
        let userInputDisplayedOrders = new Map(); 
        let loadedBaseOrderChangesFromLastSave = null; 

        const startDateTextForInstruction = initialGlobalStartDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
        if (mainInstruction) {
            mainInstruction.innerHTML = `
                系統將顯示最多${numberOfFormsToAttempt}份連續的28天預假單。首份預計起始日期為：<span id="initial-start-date-display" class="font-bold">${startDateTextForInstruction}</span>。
                <br>點擊儲存格可選擇休假類型 <span class="font-bold text-gray-700">(般: 一般假, 年: 年休, 補: 補休, C, D3)</span>。
                <br>在最近的兩份表單中，需先點擊<span class="font-bold text-blue-600">「修改順位模式」</span>按鈕並輸入密碼以啟用修改 (按鈕將變紅)。
                <br>在修改模式下，可直接在「順位」欄位輸入數字修改該員工在該表單的顯示順位。
                <br>修改完成後點擊<span class="font-bold text-green-600">「儲存目前順位」</span>即可將所有變更（轉換為基礎順位）永久保存，所有表單將一致反映新順位，並自動結束修改模式。
                <br><span class="text-red-500 font-semibold">休假規則：每人於單張預假單中，C 和 D3 最多各選一次，且 C 和 D3 不可同時選擇。</span>
                <br>若在修改模式中想中途取消，可再次點擊已變紅的「修改順位模式」按鈕 (所有變更將不會儲存)。
                <br>點擊各表單的「儲存此表單修改」按鈕，可以儲存該表單的休假紀錄。
                <br>前兩份表單提供「列印此表單」功能。
                <br><span class="text-xs text-red-600">注意：根據規則，起始日期早於「今天」的表單（已過期）將不會顯示。</span>`;
        }

        // 休假類型定義
        const leaveTypes = [
            { code: '般', name: '一般假', color: '#f472b6', className: 'leave-mark-G' },
            { code: '年', name: '年休',   color: '#60a5fa', className: 'leave-mark-A' },
            { code: '補', name: '補休',   color: '#34d399', className: 'leave-mark-C' },
            { code: 'C', name: 'C',   color: '#c084fc', className: 'leave-mark-CC' }, // 新增 C
            { code: 'D3', name: 'D3',  color: '#5eead4', className: 'leave-mark-D3' }  // 新增 D3
        ];
        let currentPopover = null; 
        let popoverTargetCell = null;

        const holidaysWithNames = [
            { date: `${appCurrentYear}-01-01`, name: "元旦" }, { date: `${appCurrentYear}-01-28`, name: "除夕" },
            { date: `${appCurrentYear}-01-29`, name: "春節" }, { date: `${appCurrentYear}-01-30`, name: "春節" },
            { date: `${appCurrentYear}-01-31`, name: "春節" }, { date: `${appCurrentYear}-02-28`, name: "和平紀念日" },
            { date: `${appCurrentYear}-04-04`, name: "兒童節/清明節" }, { date: `${appCurrentYear}-05-01`, name: "勞動節" },
            { date: `${appCurrentYear}-05-30`, name: "端午節(補假)" }, { date: `${appCurrentYear}-05-31`, name: "端午節" }, 
            { date: `${appCurrentYear}-10-06`, name: "中秋節" }, { date: `${appCurrentYear}-10-10`, name: "國慶日" }
        ];

        function calculateDisplayOrder(baseOrder, formIndex, totalEmployees = employees.length) {
            return ((baseOrder - 1 - formIndex) % totalEmployees + totalEmployees) % totalEmployees + 1;
        }

        // --- 彈窗相關函數 ---
        function showMessage(message, title = "系統訊息") {
            messageModalTitle.textContent = title;
            messageModalText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function hideMessageModal() {
            messageModal.classList.add('hidden');
        }

        okMessageButton.addEventListener('click', hideMessageModal);
        messageModal.addEventListener('click', (event) => { 
            if (event.target === messageModal) {
                hideMessageModal();
            }
        });


        function showPasswordModal() {
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
        }
        
        passwordInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                confirmPasswordButton.click(); 
            }
        });

        confirmPasswordButton.addEventListener('click', () => {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === ORDER_MODIFICATION_PASSWORD) {
                isOrderModificationModeActive = true;
                activeModeBaseOrders = JSON.parse(JSON.stringify(employees)); 
                userInputDisplayedOrders = new Map();
                // loadedBaseOrderChangesFromLastSave 保持從 localStorage 載入的值，不在此處清除
                // 進入修改模式時，不應清除上次儲存的差異，因為取消時還需要它來正確渲染
                showMessage("順位修改模式已啟用。可直接輸入顯示順位。", "模式啟用");
                hidePasswordModal();
                updateAllModifyOrderButtonsState();
                rerenderAllForms(); 
            } else {
                passwordError.textContent = "密碼錯誤，請重試。";
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        cancelPasswordButton.addEventListener('click', hidePasswordModal);
        passwordModal.addEventListener('click', (event) => {
            if (event.target === passwordModal) {
                hidePasswordModal();
            }
        });

        // --- 資料持久化函數 ---
        function getFormIdentifier(formStartDate) {
            const year = formStartDate.getFullYear();
            const month = String(formStartDate.getMonth() + 1).padStart(2, '0');
            const day = String(formStartDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function saveFormLeaveData(formElement, formIdentifier) {
            const leaveData = [];
            const rows = formElement.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const nameCell = row.querySelector('.name-cell');
                if (!nameCell) return;
                const employeeName = nameCell.textContent.trim();
                const dataCells = row.querySelectorAll('.data-cell');
                dataCells.forEach(cell => {
                    if (cell.dataset.selectedLeave) {
                        leaveData.push({
                            employeeName: employeeName,
                            date: cell.dataset.date,
                            leaveCode: cell.dataset.selectedLeave
                        });
                    }
                });
            });
            try {
                localStorage.setItem(`radiologyLeaveData_${formIdentifier}`, JSON.stringify(leaveData));
                showMessage(`表單 (起始日: ${formIdentifier}) 的休假修改已儲存！`, "儲存成功");
            } catch (e) {
                console.error(`儲存表單 ${formIdentifier} 的休假資料到 localStorage 失敗:`, e);
                showMessage(`儲存表單 ${formIdentifier} 的休假資料失敗，請檢查瀏覽器設定。`, "儲存失敗");
            }
        }

        function loadFormLeaveData(formElement, formIdentifier) {
            const savedDataJSON = localStorage.getItem(`radiologyLeaveData_${formIdentifier}`);
            if (!savedDataJSON) return;
            try {
                const savedLeaveData = JSON.parse(savedDataJSON);
                savedLeaveData.forEach(item => {
                    const rows = formElement.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const nameCell = row.querySelector('.name-cell');
                        if (nameCell && nameCell.textContent.trim() === item.employeeName) {
                            const targetCell = row.querySelector(`.data-cell[data-date="${item.date}"]`);
                            if (targetCell) {
                                const leaveType = leaveTypes.find(lt => lt.code === item.leaveCode);
                                if (leaveType) {
                                    targetCell.innerHTML = '';
                                    const leaveMarkDiv = document.createElement('div');
                                    leaveMarkDiv.className = 'leave-mark-display ' + leaveType.className;
                                    leaveMarkDiv.textContent = leaveType.code;
                                    targetCell.appendChild(leaveMarkDiv);
                                    targetCell.dataset.selectedLeave = item.leaveCode;
                                }
                            }
                        }
                    });
                });
            } catch (e) {
                console.error(`從 localStorage 載入表單 ${formIdentifier} 的休假資料失敗:`, e);
            }
        }

        function loadPersistentData() {
            const savedOrderJSON = localStorage.getItem('radiologyEmployeeOrder');
            if (savedOrderJSON) {
                try {
                    const savedOrders = JSON.parse(savedOrderJSON);
                    employees.forEach(employee => {
                        const savedData = savedOrders.find(s => s.name === employee.name);
                        if (savedData && typeof savedData.order === 'number') {
                            employee.order = savedData.order;
                        }
                    });
                } catch (e) {
                    console.error("從 localStorage 載入員工基礎順位失敗:", e);
                }
            }
            const savedChangesJSON = localStorage.getItem('radiologyLastSaveOrderChanges');
            if (savedChangesJSON) {
                try {
                    loadedBaseOrderChangesFromLastSave = JSON.parse(savedChangesJSON);
                } catch (e) {
                    console.error("從 localStorage 載入上次順位變動資訊失敗:", e);
                    loadedBaseOrderChangesFromLastSave = null;
                }
            } else {
                loadedBaseOrderChangesFromLastSave = null;
            }
        }

        // --- 順位修改邏輯 ---
        function clearModificationSessionState() {
            activeModeBaseOrders = [];
            userInputDisplayedOrders = new Map();
        }

        function updateAllModifyOrderButtonsState() {
            const allModifyButtons = document.querySelectorAll('.modify-order-control-button');
            allModifyButtons.forEach(btn => {
                btn.textContent = '修改順位模式';
                if (isOrderModificationModeActive) {
                    btn.title = '順位修改模式已啟用。再次點擊可取消修改。';
                    btn.classList.remove('modify-order-control-button-inactive');
                    btn.classList.add('modify-order-control-button-active');
                } else {
                    btn.title = '啟用後，可直接在「順位」欄位輸入數字。';
                    btn.classList.remove('modify-order-control-button-active');
                    btn.classList.add('modify-order-control-button-inactive');
                }
            });
        }
        
        function handleDisplayedOrderInputChange(event, employeeName, formIndex, inputElement) {
            const newDisplayedValue = parseInt(event.target.value);
            const totalEmployees = activeModeBaseOrders.length;

            if (isNaN(newDisplayedValue) || newDisplayedValue < 1 || newDisplayedValue > totalEmployees) {
                showMessage(`輸入的順位 "${event.target.value}" 無效。請輸入 1 到 ${totalEmployees} 之間的數字。`, "輸入錯誤");
                const empInActive = activeModeBaseOrders.find(e => e.name === employeeName);
                inputElement.value = calculateDisplayOrder(empInActive.order, formIndex, totalEmployees);
                inputElement.classList.remove('order-input-modified');
                // 從 userInputDisplayedOrders 中移除此員工的記錄
                if (userInputDisplayedOrders.has(formIndex)) {
                    userInputDisplayedOrders.get(formIndex).delete(employeeName);
                    if (userInputDisplayedOrders.get(formIndex).size === 0) {
                        userInputDisplayedOrders.delete(formIndex);
                    }
                }
                // 不需要 rerenderAllForms()，因為只是恢復單個輸入框
                return;
            }
            
            // --- 即時更新 activeModeBaseOrders ---
            const employeeToChange = activeModeBaseOrders.find(e => e.name === employeeName);
            if (!employeeToChange) return;

            const originalBaseOrderOfChangingEmp = employeeToChange.order;
            let targetNewBaseOrder = -1;
            for (let testBase = 1; testBase <= totalEmployees; testBase++) {
                if (calculateDisplayOrder(testBase, formIndex, totalEmployees) === newDisplayedValue) {
                    targetNewBaseOrder = testBase;
                    break;
                }
            }

            if (targetNewBaseOrder === -1) {
                console.error("無法計算目標基礎順位。"); 
                // 回復輸入框的值到基於當前 activeModeBaseOrders 的計算值
                inputElement.value = calculateDisplayOrder(originalBaseOrderOfChangingEmp, formIndex, totalEmployees);
                return;
            }
            
            // 如果目標基礎順位與目前基礎順位相同，則不進行任何操作
            if (targetNewBaseOrder === originalBaseOrderOfChangingEmp) {
                 if (!userInputDisplayedOrders.has(formIndex)) userInputDisplayedOrders.set(formIndex, new Map());
                 userInputDisplayedOrders.get(formIndex).set(employeeName, newDisplayedValue); // 記錄使用者的確輸入了這個值
                 inputElement.classList.add('order-input-modified');
                 inputElement.dataset.lastValidValue = newDisplayedValue;
                 // rerenderAllForms(); // 即使基礎順位沒變，也可能因為使用者輸入了與計算值相同的顯示順位而需要標記
                 return; // 不需要交換，也不需要 rerender，除非要更新標記
            }


            // 處理基礎順位衝突
            const conflictingEmployee = activeModeBaseOrders.find(e => e.order === targetNewBaseOrder && e.name !== employeeName);
            employeeToChange.order = targetNewBaseOrder;
            if (conflictingEmployee) {
                conflictingEmployee.order = originalBaseOrderOfChangingEmp;
            }
            // --- activeModeBaseOrders 更新完畢 ---

            // 記錄使用者輸入（用於在當前輸入框中保持顯示及標記）
            if (!userInputDisplayedOrders.has(formIndex)) {
                userInputDisplayedOrders.set(formIndex, new Map());
            }
            userInputDisplayedOrders.get(formIndex).set(employeeName, newDisplayedValue);
            // inputElement.classList.add('order-input-modified'); // rerenderAllForms 會處理標記
            // inputElement.dataset.lastValidValue = newDisplayedValue; // rerenderAllForms 會處理 data-initial-displayed-value

            // 即時重新渲染所有表單以反映連動
            rerenderAllForms(); 
        }


        function saveEmployeeOrder() {
            if (!isOrderModificationModeActive) {
                showMessage("請先啟用「修改順位模式」。", "提示");
                return;
            }

            const baseOrdersBeforeThisSave = JSON.parse(JSON.stringify(employees)); 
            
            const changesForThisSave = [];
            baseOrdersBeforeThisSave.forEach(initialEmp => {
                const finalEmpInActiveMode = activeModeBaseOrders.find(e => e.name === initialEmp.name);
                if (finalEmpInActiveMode && initialEmp.order !== finalEmpInActiveMode.order) {
                    changesForThisSave.push({
                        name: initialEmp.name,
                        oldBaseOrder: initialEmp.order,
                        newBaseOrder: finalEmpInActiveMode.order 
                    });
                }
            });
            
            employees = JSON.parse(JSON.stringify(activeModeBaseOrders)); 
            loadedBaseOrderChangesFromLastSave = changesForThisSave; 
            
            try {
                localStorage.setItem('radiologyEmployeeOrder', JSON.stringify(employees.map(e => ({name: e.name, order: e.order}))));
                localStorage.setItem('radiologyLastSaveOrderChanges', JSON.stringify(loadedBaseOrderChangesFromLastSave)); 
                
                isOrderModificationModeActive = false; 
                clearModificationSessionState(); 
                showMessage('員工基礎順位已成功儲存！', "儲存成功");
                rerenderAllForms(); 
            } catch (e) {
                console.error("儲存員工基礎順位到 localStorage 失敗:", e);
                showMessage('儲存員工基礎順位失敗。', "儲存失敗");
            }
        }
        

        function toggleOrderModificationMode() {
            if (isOrderModificationModeActive) { 
                isOrderModificationModeActive = false;
                clearModificationSessionState();
                // loadedBaseOrderChangesFromLastSave 保持不變，因為沒有新的儲存操作
                showMessage("順位修改已取消。所有變更已還原。", "模式取消");
                rerenderAllForms(); 
            } else { 
                showPasswordModal(); 
            }
        }

        // --- 動態調整表頭固定位置 ---
        function adjustStickyTableHeaderOffset() {
            const formContainers = document.querySelectorAll('.leave-form-container');
            formContainers.forEach(container => {
                const stickyButtonContainer = container.querySelector('.sticky-button-container');
                const table = container.querySelector('table');
                if (stickyButtonContainer && table) {
                    const buttonContainerHeight = stickyButtonContainer.offsetHeight;
                    const tableHeaders = table.querySelectorAll('thead th'); // 改為選取 thead 下所有 th
                    tableHeaders.forEach(th => {
                        th.style.top = `${buttonContainerHeight}px`;
                    });
                }
            });
        }


        // --- 表單產生與顯示 ---
        function generateDatesForForm(formStartDate, numDays) {
            const datesArray = [];
            for (let i = 0; i < numDays; i++) {
                const date = new Date(formStartDate);
                date.setDate(formStartDate.getDate() + i);
                datesArray.push(date);
            }
            return datesArray;
        }

        function createDateHeadersHTML(currentFormDates) {
            let headerContent = `<table class="min-w-full table-fixed">
                <thead class="sticky-table-header"> <tr>
                        <th class="name-header">姓名</th>
                        <th class="order-header">順位</th>`;
            currentFormDates.forEach(date => {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();
                const displayDate = `${month}/${day}`;
                const dayOfWeek = date.toLocaleDateString('zh-TW', { weekday: 'short' });
                let cellClass = "date-header"; 
                let holidayNameHTML = "";
                const dateKey = `${year}-${month}-${day}`;
                if (date.getDay() === 0 || date.getDay() === 6) cellClass += " weekend"; 
                const holidayInfo = holidaysWithNames.find(h => h.date === dateKey);
                if (holidayInfo) {
                    cellClass += " holiday";
                    holidayNameHTML = `<span class="holiday-name">${holidayInfo.name}</span>`;
                }
                headerContent += `<th class="${cellClass}">
                                    ${displayDate}<br><span class="text-xs">(${dayOfWeek})</span>${holidayNameHTML}
                                  </th>`;
            });
            headerContent += `</tr></thead>`;
            return headerContent;
        }

        function closeActivePopover() {
            if (currentPopover) {
                currentPopover.remove();
                currentPopover = null;
                popoverTargetCell = null;
            }
        }
        
        function handlePrintSpecificForm(formElement) {
            document.querySelectorAll('.leave-form-container.print-target').forEach(el => {
                el.classList.remove('print-target');
            });
            formElement.classList.add('print-target');
            window.print();
        }

        window.onafterprint = () => {
            document.querySelectorAll('.leave-form-container.print-target').forEach(el => {
                el.classList.remove('print-target');
            });
        };


        function createLeaveForm(formStartDate, formIndex) {
            const formElement = document.createElement('div');
            formElement.className = 'leave-form-container';
            const formId = getFormIdentifier(formStartDate); 
            const currentFormDates = generateDatesForForm(formStartDate, numberOfDaysPerForm);
            const formTitleElement = document.createElement('h3');
            formTitleElement.className = 'form-title';
            const endDateOfThisForm = currentFormDates[currentFormDates.length - 1];
            const startDateString = formStartDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
            const endDateString = endDateOfThisForm.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
            formTitleElement.textContent = `預假單 #${formIndex + 1} ( ${startDateString} - ${endDateString} )`;
            formElement.appendChild(formTitleElement);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'sticky-button-container flex flex-wrap items-center gap-2 sm:gap-3';

            if (formIndex === 0 || formIndex === 1) {
                const modifyOrderButton = document.createElement('button');
                modifyOrderButton.textContent = '修改順位模式';
                modifyOrderButton.className = 'px-2 py-1 sm:px-3 sm:py-1.5 text-xs rounded focus:outline-none focus:ring-2 modify-order-control-button no-print font-bold'; 
                if (isOrderModificationModeActive) {
                    modifyOrderButton.title = '順位修改模式已啟用。再次點擊可取消修改。';
                    modifyOrderButton.classList.add('modify-order-control-button-active');
                } else {
                    modifyOrderButton.title = '啟用後，可直接在「順位」欄位輸入數字。';
                    modifyOrderButton.classList.add('modify-order-control-button-inactive');
                }
                modifyOrderButton.onclick = toggleOrderModificationMode;
                buttonContainer.appendChild(modifyOrderButton);

                const saveOrderButton = document.createElement('button');
                saveOrderButton.textContent = '儲存目前順位';
                saveOrderButton.className = 'px-2 py-1 sm:px-3 sm:py-1.5 bg-green-500 text-xs rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 no-print font-bold'; 
                saveOrderButton.onclick = saveEmployeeOrder;
                buttonContainer.appendChild(saveOrderButton);
            }

            const saveFormButton = document.createElement('button');
            saveFormButton.textContent = '儲存此表單修改';
            saveFormButton.className = 'px-2 py-1 sm:px-3 sm:py-1.5 bg-purple-500 text-xs rounded hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-300 no-print font-bold'; 
            saveFormButton.onclick = function() {
                saveFormLeaveData(formElement, formId);
            };
            buttonContainer.appendChild(saveFormButton);

            if (formIndex === 0 || formIndex === 1) {
                const printButton = document.createElement('button');
                printButton.textContent = '列印此表單';
                printButton.className = 'px-2 py-1 sm:px-3 sm:py-1.5 bg-yellow-500 text-xs rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300 print-button no-print font-bold'; 
                printButton.onclick = function() {
                    handlePrintSpecificForm(formElement);
                };
                buttonContainer.appendChild(printButton);
            }

            formElement.insertBefore(buttonContainer, formTitleElement.nextSibling); 

            let tableHTML = createDateHeadersHTML(currentFormDates);
            tableHTML += `<tbody>`;
            
            const iterationSource = isOrderModificationModeActive ? activeModeBaseOrders : employees;

            iterationSource.forEach(employeeData => { 
                const employeeName = employeeData.name;
                let baseOrderForDisplayCalculation;
                let finalDisplayedOrderValue;

                if (!isOrderModificationModeActive && loadedBaseOrderChangesFromLastSave) {
                    const changeInfo = loadedBaseOrderChangesFromLastSave.find(c => c.name === employeeName);
                    if (changeInfo && formIndex > 0) { 
                        baseOrderForDisplayCalculation = changeInfo.oldBaseOrder;
                    } else { 
                        const currentGlobalEmp = employees.find(e => e.name === employeeName);
                        baseOrderForDisplayCalculation = currentGlobalEmp ? currentGlobalEmp.order : employeeData.order;
                    }
                } else { 
                     baseOrderForDisplayCalculation = employeeData.order; // In mod mode, or no last save diff
                }
                finalDisplayedOrderValue = calculateDisplayOrder(baseOrderForDisplayCalculation, formIndex, iterationSource.length);
                
                tableHTML += `<tr><td class="name-cell">${employeeName}</td><td class="order-cell" data-employee-name="${employeeName}">`;
                
                if (isOrderModificationModeActive && (formIndex === 0 || formIndex === 1)) {
                    const empInActive = activeModeBaseOrders.find(e => e.name === employeeName);
                    let inputValue = calculateDisplayOrder(empInActive.order, formIndex, activeModeBaseOrders.length);
                    
                    // Check if user has specifically typed a value for this cell in this session
                    const formSpecificUserInput = userInputDisplayedOrders.get(formIndex);
                    const isModifiedByUserInThisCell = formSpecificUserInput && formSpecificUserInput.has(employeeName);
                    if (isModifiedByUserInThisCell) {
                         inputValue = formSpecificUserInput.get(employeeName);
                    }

                    tableHTML += `<input type="number" value="${inputValue}" 
                                         class="${isModifiedByUserInThisCell ? 'order-input-modified' : ''}" 
                                         data-employee-name="${employeeName}" 
                                         data-form-index="${formIndex}"
                                         data-initial-displayed-value="${calculateDisplayOrder(empInActive.order, formIndex, activeModeBaseOrders.length)}">`; 
                } else {
                    tableHTML += finalDisplayedOrderValue; 
                }
                tableHTML += `</td>`;

                currentFormDates.forEach(date => {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = date.getFullYear();
                    const dateKey = `${year}-${month}-${day}`;
                    let cellClasses = "data-cell";
                    if (date.getDay() === 0 || date.getDay() === 6) cellClasses += " weekend";
                    if (holidaysWithNames.find(h => h.date === dateKey)) cellClasses += " holiday";
                    tableHTML += `<td class="${cellClasses}" data-date="${dateKey}"></td>`;
                });
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;
            const tableContainer = document.createElement('div'); 
            tableContainer.innerHTML = tableHTML;
            formElement.appendChild(tableContainer.firstChild); 
            leaveFormsContainer.appendChild(formElement);

            loadFormLeaveData(formElement, formId); 

            if (isOrderModificationModeActive && (formIndex === 0 || formIndex === 1)) {
                formElement.querySelectorAll('.order-cell input[type="number"]').forEach(input => {
                    input.dataset.lastValidValue = input.value; 
                    input.addEventListener('change', (event) => {
                        handleDisplayedOrderInputChange(event, event.target.dataset.employeeName, parseInt(event.target.dataset.formIndex), event.target);
                    });
                    input.addEventListener('focus', (event) => { 
                        event.target.dataset.focusedValue = event.target.value;
                    });
                     input.addEventListener('blur', (event) => { 
                        if (event.target.value === "" || isNaN(parseInt(event.target.value))) {
                            const empName = event.target.dataset.employeeName;
                            const fIndex = parseInt(event.target.dataset.formIndex);
                            const empBaseOrder = activeModeBaseOrders.find(e => e.name === empName).order;
                            event.target.value = calculateDisplayOrder(empBaseOrder, fIndex, activeModeBaseOrders.length);
                            event.target.classList.remove('order-input-modified');
                             if (userInputDisplayedOrders.has(fIndex)) {
                                userInputDisplayedOrders.get(fIndex).delete(empName);
                                if (userInputDisplayedOrders.get(fIndex).size === 0) {
                                    userInputDisplayedOrders.delete(fIndex);
                                }
                            }
                        }
                    });
                });
            }


            const dataCells = formElement.querySelectorAll('.data-cell');
            dataCells.forEach(cell => {
                cell.addEventListener('click', function (event) {
                    event.stopPropagation(); 
                    if (popoverTargetCell === this && currentPopover) {
                        closeActivePopover(); return; 
                    }
                    closeActivePopover(); 
                    popoverTargetCell = this; 
                    const currentEmployeeName = this.closest('tr').querySelector('.name-cell').textContent.trim();


                    const popover = document.createElement('div');
                    popover.className = 'leave-type-popover';
                    leaveTypes.forEach(lt => {
                        const btn = document.createElement('button');
                        btn.textContent = lt.name;
                        btn.dataset.leaveCode = lt.code;
                        btn.dataset.leaveClassName = lt.className;
                        btn.style.backgroundColor = lt.color; 
                        btn.classList.add('popover-leave-type-btn'); 
                        btn.onclick = function() {
                            const targetLeaveCode = this.dataset.leaveCode;
                            // 休假類型選擇規則檢查 (C 和 D3)
                            if (targetLeaveCode === 'C' || targetLeaveCode === 'D3') {
                                const cellsInRow = Array.from(popoverTargetCell.closest('tr').querySelectorAll('.data-cell'));
                                let cExists = false;
                                let d3Exists = false;
                                let cExistsInOtherCell = false;
                                let d3ExistsInOtherCell = false;

                                cellsInRow.forEach(c => {
                                    if (c.dataset.selectedLeave === 'C') {
                                        cExists = true;
                                        if (c !== popoverTargetCell) cExistsInOtherCell = true;
                                    }
                                    if (c.dataset.selectedLeave === 'D3') {
                                        d3Exists = true;
                                        if (c !== popoverTargetCell) d3ExistsInOtherCell = true;
                                    }
                                });

                                if (targetLeaveCode === 'C') {
                                    if (d3Exists) {
                                        showMessage(`錯誤：${currentEmployeeName} 在此表單已選擇 D3，無法再選擇 C。`, "選擇衝突");
                                        closeActivePopover(); return;
                                    }
                                    if (cExistsInOtherCell) {
                                        showMessage(`錯誤：${currentEmployeeName} 在此表單已選擇 C，每人每表單限選一次 C。`, "選擇衝突");
                                        closeActivePopover(); return;
                                    }
                                } else if (targetLeaveCode === 'D3') {
                                    if (cExists) {
                                        showMessage(`錯誤：${currentEmployeeName} 在此表單已選擇 C，無法再選擇 D3。`, "選擇衝突");
                                        closeActivePopover(); return;
                                    }
                                    if (d3ExistsInOtherCell) {
                                        showMessage(`錯誤：${currentEmployeeName} 在此表單已選擇 D3，每人每表單限選一次 D3。`, "選擇衝突");
                                        closeActivePopover(); return;
                                    }
                                }
                            }
                            // --- 規則檢查結束 ---

                            popoverTargetCell.innerHTML = ''; 
                            leaveTypes.forEach(type => popoverTargetCell.classList.remove(type.className));
                            const leaveMarkDiv = document.createElement('div');
                            leaveMarkDiv.className = 'leave-mark-display ' + this.dataset.leaveClassName;
                            leaveMarkDiv.textContent = this.dataset.leaveCode;
                            popoverTargetCell.appendChild(leaveMarkDiv);
                            popoverTargetCell.dataset.selectedLeave = this.dataset.leaveCode; 
                            closeActivePopover();
                        };
                        popover.appendChild(btn);
                    });
                    const clearBtn = document.createElement('button');
                    clearBtn.textContent = '清除';
                    clearBtn.classList.add('popover-clear-btn');
                    clearBtn.onclick = function() {
                        popoverTargetCell.innerHTML = '';
                        leaveTypes.forEach(type => popoverTargetCell.classList.remove(type.className));
                        delete popoverTargetCell.dataset.selectedLeave;
                        closeActivePopover();
                    };
                    popover.appendChild(clearBtn);

                    document.body.appendChild(popover); 
                    currentPopover = popover;

                    const rect = this.getBoundingClientRect();
                    let topPosition = rect.bottom + window.scrollY + 2;
                    let leftPosition = rect.left + window.scrollX;
                    
                    popover.style.top = `${topPosition}px`;
                    popover.style.left = `${leftPosition}px`;

                    const popoverRect = popover.getBoundingClientRect();
                    if (popoverRect.right > window.innerWidth - 10) { 
                        popover.style.left = `${window.innerWidth - popoverRect.width - 10}px`;
                    }
                    if (popoverRect.left < 10) { popover.style.left = '10px'; }
                    if (popoverRect.bottom > window.innerHeight -10 ) { 
                         popover.style.top = `${rect.top + window.scrollY - popoverRect.height - 2}px`;
                    }
                     if (popoverRect.top < 10 && (rect.top + window.scrollY - popoverRect.height - 2) < 10 ) {
                        popover.style.top = '10px';
                    }
                });
            });
        }

        function rerenderAllForms() {
            leaveFormsContainer.innerHTML = ''; 
            closeActivePopover(); 
            generateAndDisplayForms(); 
            updateAllModifyOrderButtonsState(); 
            // loadedBaseOrderChangesFromLastSave 的狀態由 loadPersistentData 和 saveEmployeeOrder 管理
            // 在 rerenderAllForms 完成後，如果不是在修改模式下，則可以清除它，
            // 因為它的作用是在 "儲存後的那一次渲染" 中影響後續表單。
            // 但為了讓頁面重整後也能維持效果，它必須從 localStorage 載入。
            // 因此，這裡不需要清除它，除非是在進入新的修改會話時。
        }

        function generateAndDisplayForms() {
            let dateForNextForm = new Date(initialGlobalStartDate);
            let validFormsCount = 0; 

            for (let slotIndex = 0; slotIndex < numberOfFormsToAttempt; slotIndex++) {
                if (validFormsCount >= numberOfFormsToAttempt) { 
                    break;
                }
                const potentialStartDate = new Date(dateForNextForm);
                potentialStartDate.setHours(0, 0, 0, 0); 
                if (potentialStartDate < today) {
                    dateForNextForm.setDate(dateForNextForm.getDate() + numberOfDaysPerForm); 
                    continue; 
                }
                createLeaveForm(new Date(potentialStartDate), validFormsCount); 
                validFormsCount++; 
                dateForNextForm.setDate(dateForNextForm.getDate() + numberOfDaysPerForm);
            }
            
            if (validFormsCount === 0) {
                const noFormsMessage = document.createElement('p');
                noFormsMessage.className = 'text-center text-red-600 font-semibold py-4';
                noFormsMessage.textContent = '根據目前設定與日期規則，沒有可顯示的預假單。';
                leaveFormsContainer.appendChild(noFormsMessage);
                if (mainInstruction && !document.getElementById('no-forms-active-warning')) {
                    const warningSpan = document.createElement('span');
                    warningSpan.id = 'no-forms-active-warning';
                    warningSpan.innerHTML = '<br><strong class="text-red-700">目前沒有表單可供填寫。</strong>';
                    mainInstruction.appendChild(warningSpan);
                }
            } else {
                 const existingWarning = document.getElementById('no-forms-active-warning');
                 if (existingWarning) existingWarning.remove();
            }
            adjustStickyTableHeaderOffset(); // 所有表單產生完畢後調整一次
        }

        // --- 初始化 ---
        loadPersistentData(); 
        generateAndDisplayForms(); 

        document.addEventListener('click', function(event) {
            if (currentPopover && !currentPopover.contains(event.target) && popoverTargetCell && !popoverTargetCell.contains(event.target)) {
                closeActivePopover();
            }
        });
        window.addEventListener('resize', adjustStickyTableHeaderOffset); // 視窗大小改變時也調整
    </script>
</body>
</html>
